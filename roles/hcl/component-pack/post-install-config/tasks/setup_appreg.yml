---
- name:                                     "Verify if properties were added"
  stat:
    path:                                   "{{ __success_file }}"
  register:                                 lcc_props_added

- name:                                     Add appreg hostname and protocol genericProperties to lcc.xml
  community.general.xml:
    path:                                   "{{ __lcc_full_path }}"
    xpath:                                  "{{ __lcc_version_xpath }}"
    namespaces:                             "{{ __lcc_namespaces }}"
    input_type: xml
    pretty_print: yes
    add_children:
      - "<genericProperty name=\"appreg.hostname\">{{ dmgr_hostname }}</genericProperty>"
      - "<genericProperty name=\"appreg.protocol\">https</genericProperty>"
  register:                                 add_node
  when:                                     not lcc_props_added.stat.exists

- name:                                     print node
  ansible.builtin.debug:
    msg:                                    "{{ add_node.changed }}"
  verbosity: 1

- name:                                     "Create {{ __success_file }} file"
  file:
    path:                                   "{{ __success_file }}"
    state:                                  touch
  when:                                     add_node.changed |bool

# Query element text using XPath
- name:                                     Enable service extensionRegistry
  community.general.xml:
    path:                                   "{{ __lcc_full_path }}"
    xpath:                                  "{{ __lcc_sloc_service_extRegistry_xpath }}"
    content:                                attribute
    namespaces:                             "{{ __lcc_namespaces }}"
  register:                                 get_element_text

- name:                                     Print get_element_text@enabled
  ansible.builtin.debug: 
    var: "get_element_text.matches[0]['{http://www.ibm.com/service-location}serviceReference']['enabled']"
  verbosity: 1

- name:                                     Print get_element_text@ssl_enabled
  ansible.builtin.debug: 
    var: "get_element_text.matches[0]['{http://www.ibm.com/service-location}serviceReference']['ssl_enabled']"
  verbosity: 1

- name:                                     Service extensionRegistry@enabled
  block:
    - name:                                 Update extensionRegistry@enabled
      xml:
        path:                               "{{ __lcc_full_path }}"
        xpath:                              "{{ __lcc_sloc_service_extRegistry_xpath }}"
        value:                              "true"
        attribute:                          "enabled"
        namespaces:                         "{{ __lcc_namespaces }}"
      register:                             isExtReg_enabled
      when:                                 get_element_text.count == 1

    - name:                                 Update extensionRegistry@ssl_enabled
      xml:
        path:                               "{{ __lcc_full_path }}"
        xpath:                              "{{ __lcc_sloc_service_extRegistry_xpath }}"
        value:                              "true"
        attribute:                          "ssl_enabled"
        namespaces:                         "{{ __lcc_namespaces }}"
      register:                             isExtReg_ssl_enabled
      when:                                 get_element_text.count == 1

- name:                                     Print extensionRegistry@ssl_enabled
  ansible.builtin.debug: 
    msg:  "{{ isExtReg_ssl_enabled.changed }}"
  verbosity: 1

- name:                                     Print extensionRegistry@enabled
  ansible.builtin.debug: 
    msg:                                    "{{ isExtReg_enabled.changed }}"
  verbosity: 1
