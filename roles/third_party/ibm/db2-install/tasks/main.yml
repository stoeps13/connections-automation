---
- name:                       Install prereq for community.general.pids
  yum:
    name:                     python3-psutil
    state:                    present

- name:                       Check if DB2 is already up and running
  community.general.pids:
    name: db2sysc
  register:                   db2_running
  changed_when:               false
  ignore_errors:              true

- name:                       Check DB2 installed
  ansible.builtin.debug:
    msg:                      "DB2 is already up and running"
    verbosity: 1
  when:
    - db2_running.pids | length > 0

- name:                       Prepare Environment for DB2
  include_tasks:              setup_os.yml
  when:
    - "'db2_servers' in group_names"
    - inventory_hostname in groups["db2_servers"]
    - db2_running.pids | length  == 0

- name:                       Download and prepare DB2
  include_tasks:              download_db2.yml
  when:
    - "'db2_servers' in group_names"
    - inventory_hostname in groups["db2_servers"]
    - db2_running.pids | length  == 0

- name:                       Install DB2
  include_tasks:              install_db2.yml
  when:
    - "'db2_servers' in group_names"
    - inventory_hostname in groups["db2_servers"]
    - db2_running.pids | length  == 0

# Seems to ignore errors and no become instance owner?
- name:                       Apply the license to DB2
  include_tasks:              setup_license.yml
  when:
    - "'db2_servers' in group_names"
    - inventory_hostname in groups["db2_servers"]
    - db2_running.pids | length  == 0

- name:                       Setup Codepage
  include_tasks:              setup_codepage.yml
  when:
    - "'db2_servers' in group_names"
    - inventory_hostname in groups["db2_servers"]
    - db2_running.pids | length  == 0

- name:                       Apply tunings
  include_tasks:              apply_tunings.yml
  when:
    - "'db2_servers' in group_names"
    - inventory_hostname in groups["db2_servers"]
    - db2_running.pids | length  == 0

- name:                       Install jdbc drivers only
  include_tasks:              install_jdbc.yml
  when:
    - inventory_hostname in groups["was_servers"]
    - __setup_db2_jdbc |bool
