---
- name: Install python kubernetes client
  ansible.builtin.pip:
    name: kubernetes

# https://docs.tigera.io/calico/3.25/getting-started/kubernetes/quickstart
- name: Download the Calico networking manifest for the Kubernetes API datastore
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/projectcalico/calico/v{{ __calico_version }}/manifests/calico.yaml
    dest: /tmp/calico.yml
  when:
    - inventory_hostname == groups['k8s_masters'][0]
  become: false

- name: Check if calico is already deployed
  kubernetes.core.k8s:
    state: present
    src: /tmp/calico.yml

- name: Wait till all calico pods are created
  shell: "kubectl get po --namespace=kube-system --output=jsonpath='{.items[*].metadata.name}'"
  register: calico_pods_created
  until: item in calico_pods_created.stdout
  become: false
  retries: 10
  delay: 10
  with_items:
    - calico-kube-controllers
    - calico-node

- name: Wait for calico Deployment to become ready
  shell: "kubectl -n kube-system rollout status deploy calico-kube-controllers --timeout=300s"
  when:
    - inventory_hostname == groups['k8s_masters'][0]
  become: false

- name: Wait for calico DaemonSet to become ready
  shell: "kubectl -n kube-system rollout status ds calico-node --timeout=300s"
  when:
    - inventory_hostname == groups['k8s_masters'][0]
  become: false
